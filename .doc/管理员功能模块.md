# 管理员功能模块设计

## 1. 设计思路

管理员功能模块是整个系统的中枢控制台，其设计核心在于确保系统的安全、稳定、高效运行，并为管理员提供便捷、强大的管理工具。

*   **核心目标:**
    *   **高效管理:** 提供全面、精细化的管理功能，覆盖用户、商户、内容、系统等多个维度，提升管理效率。
    *   **安全可控:** 建立严格的权限控制体系和操作审计机制，保障系统数据安全，防止未授权访问和误操作。
    *   **稳定可靠:** 保证管理后台自身的高可用性和稳定性，确保在各种情况下都能正常履行管理职责。
    *   **易用便捷:** 提供清晰直观的操作界面和流畅的交互体验（尽管本处主要设计后端接口，但接口设计需考虑前端易用性）。
    *   **可扩展性:** 模块设计应具备良好的扩展性，以适应未来业务发展带来的新管理需求。

*   **设计原则:**
    *   **职责分离原则:** 管理员模块的功能应与前台用户、商户模块的功能明确分离，接口路径、认证机制独立。
    *   **最小权限原则:** 基于角色的访问控制 (RBAC)，管理员只拥有其执行任务所必需的最小权限。
    *   **清晰的API定义:** 遵循接口文档中的RESTful风格和统一响应格式，确保接口的易理解性和易集成性。
    *   **全面的操作审计:** 对所有关键操作进行日志记录，便于追踪问题和安全审计。
    *   **数据一致性:** 管理操作需确保数据的一致性和完整性，特别是在涉及多表操作或状态变更时。

*   **关键考量:**
    *   **权限管理的粒度:** 需要细化到接口级别甚至按钮级别的权限控制。
    *   **数据校验的完备性:** 对所有输入参数进行严格校验，防止非法数据注入。
    *   **异步处理与反馈:** 对于耗时操作（如批量数据处理、数据导出），应考虑采用异步处理机制，并提供明确的任务状态反馈。
    *   **错误处理与提示:** 提供清晰、友好的错误提示信息，帮助管理员快速定位和解决问题。
    *   **版本兼容性:** API接口设计应考虑后续升级的兼容性问题。

## 2. 架构设计

管理员模块将采用主流的后端分层架构，确保模块内部的高内聚、低耦合，便于开发和维护。

*   **模块划分 (基于API文档):**
    1.  **认证与授权模块 (Admin Auth Module):**
        *   负责管理员的登录、登出、Token管理。
        *   提供当前管理员信息及权限查询。
        *   集成 Sa-Token 实现权限校验逻辑。
    2.  **用户管理模块 (User Management Module):**
        *   提供用户列表查询、状态修改、详情查看等功能。
    3.  **商户管理模块 (Merchant Management Module):**
        *   **商户账户管理:** 列表查询、注册申请列表、审核、状态修改、资质查看。
        *   **商户分类管理:** 分类列表查询、增删改查。
    4.  **内容审核模块 (Content Moderation Module):**
        *   **商品信息审核:** 待审核列表查询、商品审核。
        *   **用户评论审核:** 待审核列表查询、评论审核。
        *   **举报处理:** 举报列表查询、举报处理。
    5.  **系统监控与数据统计模块 (System & Stats Module):**
        *   **核心数据统计:** 业务数据摘要查询。
        *   **数据导出:** 按类型导出业务数据。
        *   **预警管理:** 预警历史查询。
    6.  **操作日志模块 (Audit Log Module):**
        *   记录管理员的关键操作，用于审计和追踪。

*   **分层架构:**
    *   **表现层 (Controller Layer):**
        *   直接对外提供 RESTful API 接口，定义在 `/api/admin` 路径下。
        *   负责接收HTTP请求，参数校验和转换。
        *   调用业务逻辑层处理请求，并组装统一的响应格式返回。
    *   **业务逻辑层 (Service Layer):**
        *   实现模块的核心业务逻辑，如用户状态变更、商户审核流程、内容审批规则等。
        *   编排和调用数据访问层接口，处理复杂的业务规则和数据转换。
        *   处理事务，确保数据操作的原子性。
    *   **数据访问层 (Repository/DAO Layer):**
        *   负责与数据库进行交互，执行数据的增删改查操作。
        *   定义数据实体和映射关系。
    *   **领域模型层 (Domain Layer):**
        *   包含核心的业务实体对象（如AdminUser, Role, Permission等，以及对User, Merchant等外部实体的引用和适配）。
    *   **基础设施层 (Infrastructure Layer):**
        *   提供通用的技术支持，如数据库连接池、缓存服务 (Redis)、认证授权组件 (Sa-Token)、日志组件、工具类等。

*   **组件交互图 (简化):**
    ```
    [客户端/Admin UI] -> [API Gateway (可选)] -> [Admin Controller Layer]
                                                     |
                                                     v
                                          [Admin Service Layer] (包含各业务模块服务)
                                                     |  ^
                                                     |  | (调用其他服务/模块)
                                                     v
                                          [Admin Repository Layer] -> [Database]
                                                     |
                                                     v
                                          [Infrastructure Layer (Sa-Token, Redis, Logging)]
    ```

## 3. 数据模型与用例设计
### 3.1 数据模型设计

管理员模块自身需要的数据模型，以及与现有业务数据模型的关联。

*   **核心管理员模型:**
    1.  **管理员表 (hmdp_admin_user):**
        *   `id` (BIGINT, PK, AutoIncrement): 管理员ID
        *   `username` (VARCHAR(50), Unique, NotNull): 用户名
        *   `password` (VARCHAR(100), NotNull): 加密后的密码
        *   `avatar` (VARCHAR(255), Nullable): 头像URL
        *   `status` (TINYINT, NotNull, Default 0): 状态 (0-正常, 1-禁用)
        *   `create_time` (DATETIME, NotNull, Default CURRENT_TIMESTAMP): 创建时间
        *   `update_time` (DATETIME, NotNull, Default CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP): 更新时间
        *   `deleted` (TINYINT, NotNull, Default 0): 逻辑删除标记 (0-未删除, 1-已删除)

    2.  **角色表 (hmdp_admin_role):**
        *   `id` (BIGINT, PK, AutoIncrement): 角色ID
        *   `name` (VARCHAR(50), Unique, NotNull): 角色名称 (如：超级管理员, 用户管理员, 内容审核员)
        *   `code` (VARCHAR(50), Unique, NotNull): 角色编码 (如：SUPER_ADMIN, USER_MANAGER, CONTENT_AUDITOR)
        *   `description` (VARCHAR(255), Nullable): 角色描述
        *   `status` (TINYINT, NotNull, Default 0): 状态 (0-正常, 1-禁用)
        *   `create_time` (DATETIME, NotNull, Default CURRENT_TIMESTAMP)
        *   `update_time` (DATETIME, NotNull, Default CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP)
        *   `deleted` (TINYINT, NotNull, Default 0)

    3.  **权限表 (hmdp_admin_permission):**
        *   `id` (BIGINT, PK, AutoIncrement): 权限ID
        *   `name` (VARCHAR(100), NotNull): 权限名称 (例如：查询用户列表, 禁用用户, 审核商品，主要用于后台管理界面展示和理解)
        *   `code` (VARCHAR(100), Unique, NotNull): 权限标识 (例如：`user:list`, `user:disable`, `product:audit`，此为后端进行权限校验的核心依据)
        *   `description` (VARCHAR(255), Nullable): 权限描述 (可选，用于进一步说明该权限的作用)
        *   `status` (TINYINT, NotNull, Default 0): 状态 (0-正常, 1-禁用)
        *   `create_time` (DATETIME, NotNull, Default CURRENT_TIMESTAMP): 创建时间
        *   `update_time` (DATETIME, NotNull, Default CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP): 更新时间
        *   `deleted` (TINYINT, NotNull, Default 0): 逻辑删除标记 (0-未删除, 1-已删除)

    4.  **管理员-角色关联表 (hmdp_admin_user_role):**
        *   `id` (BIGINT, PK, AutoIncrement)
        *   `admin_user_id` (BIGINT, NotNull, FK -> hmdp_admin_user.id): 管理员ID
        *   `role_id` (BIGINT, NotNull, FK -> hmdp_admin_role.id): 角色ID
        *   `create_time` (DATETIME, NotNull, Default CURRENT_TIMESTAMP)

    5.  **角色-权限关联表 (hmdp_admin_role_permission):**
        *   `id` (BIGINT, PK, AutoIncrement)
        *   `role_id` (BIGINT, NotNull, FK -> hmdp_admin_role.id): 角色ID
        *   `permission_id` (BIGINT, NotNull, FK -> hmdp_admin_permission.id): 权限ID
        *   `create_time` (DATETIME, NotNull, Default CURRENT_TIMESTAMP)

    6.  **管理员操作日志表 (hmdp_admin_audit_log):**
        *   `id` (BIGINT, PK, AutoIncrement): 日志ID
        *   `admin_user_id` (BIGINT, NotNull): 操作管理员ID
        *   `admin_username` (VARCHAR(50), NotNull): 操作管理员用户名
        *   `action_name` (VARCHAR(100), Nullable): 操作名称 (如：禁用用户)
        *   `request_uri` (VARCHAR(255), Nullable): 请求URI
        *   `request_method` (VARCHAR(10), Nullable): 请求方法 (GET, POST, PUT, DELETE)
        *   `request_params` (TEXT, Nullable): 请求参数 (JSON格式)
        *   `ip_address` (VARCHAR(50), Nullable): 操作IP
        *   `duration_ms` (BIGINT, Nullable): 操作耗时 (毫秒)
        *   `status` (TINYINT, NotNull, Default 0): 操作状态 (0-成功, 1-失败)
        *   `error_message` (TEXT, Nullable): 错误信息 (如果操作失败)
        *   `create_time` (DATETIME, NotNull, Default CURRENT_TIMESTAMP): 操作时间

*   **关联现有业务模型 (基于API文档，假设这些表已存在于主业务库):**
    *   `hmdp_user`: 用户信息表 (管理员模块会查询和修改其状态)
    *   `hmdp_shop`: 商户店铺信息表 (管理员模块会查询和修改其状态)
    *   `hmdp_shop_type`: 商户分类表 (管理员模块会进行CRUD操作)
    *   `hmdp_merchant_application`: 商户注册申请表 (管理员进行审核)
        *   包含 `application_id`, `merchant_name`, `applicant_name`, `applicant_phone`, `apply_time`, `status` (0-待审核, 1-已通过, 2-已拒绝), `audit_comment` 等字段。
    *   `hmdp_merchant_qualification`: 商户资质信息表 (管理员查看)
    *   `hmdp_product`: 商品信息表 (管理员进行审核，修改其审核状态 `audit_status` 和 `audit_reason`)
    *   `hmdp_comment`: 用户评论表 (管理员进行审核，修改其显示状态 `display_status` 和 `audit_reason`)
    *   `hmdp_report`: 举报信息表 (管理员进行处理，修改其处理状态 `process_status`, `process_action`, `process_remarks`)
    *   `hmdp_alert_history`: 预警历史表 (管理员查询)
        *   包含 `history_id`, `alert_name`, `trigger_time`, `details`, `severity`, `status` (TRIGGERED, RESOLVED) 等字段。

*   **数据字典:**
    *   状态字段 (`status`, `type` 等) 应建立统一的数据字典或枚举类进行管理，确保含义一致。

### 3.2 系统用例描述

#### 3.2.1 管理员认证与授权模块
- **参与者：** 系统管理员
- **前置条件：**
    - 管理员拥有有效的用户名和密码。
    - 系统登录界面已打开。
- **后置条件：**
    - 管理员成功登录系统，获得访问授权。
    - 系统记录登录日志。
    - 系统为管理员生成并返回访问令牌 (Token)。
- **主事件流：**
    1. 管理员在登录界面输入用户名和密码。
    2. 管理员点击"登录"按钮。
    3. 系统验证管理员输入的用户名和密码的正确性。
    4. 系统验证管理员账户状态是否正常。
    5. 系统生成访问令牌 (Token)，并将其与管理员会话关联。
    6. 系统跳转到管理员后台主界面。
    7. 系统向管理员反馈登录成功的信息。
- **备选事件流：**
    *   3.2.1.1.A. 用户名或密码错误
        1.  系统提示"用户名或密码错误"。
        2.  管理员重新输入用户名和密码。
        3.  用例返回主事件流第3步。
    *   3.2.1.1.B. 账户被禁用
        1.  系统提示"账户已被禁用，请联系超级管理员"。
        2.  用例终止。
    *   3.2.1.1.C. 输入信息不完整
        1.  系统提示"请输入用户名和密码"。
        2.  管理员补充输入信息。
        3.  用例返回主事件流第3步。

##### 3.2.1.2 用例名称：管理员登出
- **参与者：** 系统管理员
- **前置条件：**
    - 管理员已登录系统。
- **后置条件：**
    - 管理员成功退出系统，当前会话失效。
    - 系统清除与管理员相关的登录状态和Token。
- **主事件流：**
    1. 管理员在系统界面中选择"登出"或"退出登录"功能。
    2. 系统提示管理员确认是否登出。
    3. 管理员确认登出操作。
    4. 系统清除当前管理员的会话信息和Token。
    5. 系统跳转到登录界面。
    6. 系统记录管理员登出日志。
- **备选事件流：**
    *   3.2.1.2.A. 管理员取消登出
        1.  管理员选择取消登出操作。
        2.  用例终止，管理员保持登录状态。

##### 3.2.1.3 用例名称：查看个人（管理员）信息
- **参与者：** 系统管理员
- **前置条件：**
    - 管理员已登录系统。
- **后置条件：**
    - 管理员成功查看到自己的账户信息、角色及权限。
- **主事件流：**
    1. 管理员在系统界面中选择"个人中心"或"查看资料"功能。
    2. 系统查询当前登录管理员的账户信息，包括用户名、角色、头像、权限列表等。
    3. 系统在界面上展示管理员的详细信息。
- **备选事件流：**
    *   3.2.1.3.A. 获取信息失败
        1.  系统提示"获取管理员信息失败，请稍后重试"。
        2.  用例终止。

#### 3.2.2 用户管理模块

##### 3.2.2.1 用例名称：查询用户列表
- **参与者：** 系统管理员
- **前置条件：**
    - 管理员已登录系统。
    - 管理员具有查看用户列表的权限。
- **后置条件：**
    - 系统根据查询条件展示用户列表。
- **主事件流：**
    1. 管理员在导航菜单中选择"用户管理"功能。
    2. 系统默认显示第一页的用户列表。
    3. 管理员可以输入查询条件（如：用户昵称、手机号、状态）。
    4. 管理员点击"搜索"或"查询"按钮。
    5. 系统根据管理员输入的条件从数据库中检索匹配的用户信息。
    6. 系统在界面上分页展示查询到的用户列表，包括用户ID、昵称、手机号、状态、注册时间等。
    7. 管理员可以进行翻页操作查看更多用户。
- **备选事件流：**
    *   3.2.2.1.A. 无符合条件的用户
        1.  系统提示"未找到符合条件的用户记录"。
        2.  列表显示为空。
    *   3.2.2.1.B. 查询参数无效
        1.  系统提示参数错误信息。
        2.  管理员修改查询参数后重新查询。

##### 3.2.2.2 用例名称：修改用户状态
- **参与者：** 系统管理员
- **前置条件：**
    - 管理员已登录系统。
    - 管理员具有修改用户状态的权限。
    - 已查询并展示用户列表。
- **后置条件：**
    - 选定用户的状态被成功修改（如：正常变为禁用，或禁用变为正常）。
    - 系统记录操作日志。
- **主事件流：**
    1. 管理员在用户列表中选中一个或多个需要修改状态的用户。
    2. 管理员选择"禁用"或"启用"用户的操作。
    3. 系统提示管理员确认操作。
    4. 管理员确认修改用户状态。
    5. 系统更新数据库中对应用户的状态字段。
    6. 系统刷新用户列表，显示更新后的用户状态。
    7. 系统向管理员反馈操作成功的信息。
- **备选事件流：**
    *   3.2.2.2.A. 修改失败
        1.  系统提示"修改用户状态失败，请稍后重试"。
        2.  用户状态未改变。
    *   3.2.2.2.B. 管理员取消操作
        1.  管理员在确认提示框中选择"取消"。
        2.  用例终止，用户状态未改变。

##### 3.2.2.3 用例名称：查看用户详细信息
- **参与者：** 系统管理员
- **前置条件：**
    - 管理员已登录系统。
    - 管理员具有查看用户详情的权限。
    - 已查询并展示用户列表。
- **后置条件：**
    - 系统展示指定用户的详细信息。
- **主事件流：**
    1. 管理员在用户列表中选择一个用户，并点击"查看详情"或类似操作。
    2. 系统根据用户ID查询该用户的详细信息，如基本资料、订单记录、签到情况、关注列表等。
    3. 系统在新页面或弹窗中展示用户的详细信息。
- **备选事件流：**
    *   3.2.2.3.A. 用户信息不存在
        1.  系统提示"无法找到该用户的详细信息"。
        2.  用例终止。

#### 3.2.3 商户管理模块

##### 3.2.3.1 商户账户管理

###### 3.2.3.1.1 用例名称：查询商户列表
- **参与者：** 系统管理员
- **前置条件：**
    - 管理员已登录系统。
    - 管理员具有查看商户列表的权限。
- **后置条件：**
    - 系统根据查询条件展示商户列表。
- **主事件流：**
    1. 管理员在导航菜单中选择"商户管理"下的"商户列表"功能。
    2. 系统默认显示第一页的商户列表。
    3. 管理员可以输入查询条件（如：商户名称、状态、商户分类）。
    4. 管理员点击"搜索"或"查询"按钮。
    5. 系统根据管理员输入的条件从数据库中检索匹配的商户信息。
    6. 系统在界面上分页展示查询到的商户列表，包括商户ID/店铺ID、名称、分类、状态、申请时间、审核时间等。
    7. 管理员可以进行翻页操作查看更多商户。
- **备选事件流：**
    *   3.2.3.1.1.A. 无符合条件的商户
        1.  系统提示"未找到符合条件的商户记录"。
        2.  列表显示为空。

###### 3.2.3.1.2 用例名称：查询商户注册申请列表
- **参与者：** 系统管理员
- **前置条件：**
    - 管理员已登录系统。
    - 管理员具有审核商户注册申请的权限。
- **后置条件：**
    - 系统根据筛选条件展示商户注册申请列表。
- **主事件流：**
    1. 管理员在导航菜单中选择"商户管理"下的"注册申请审核"功能。
    2. 系统默认显示待审核的商户申请列表。
    3. 管理员可以筛选申请状态（如：待审核、已通过、已拒绝）。
    4. 管理员点击"查询"按钮。
    5. 系统根据筛选条件从数据库中检索商户注册申请记录。
    6. 系统在界面上分页展示申请列表，包括申请ID、申请商户名、申请人、联系电话、申请时间、状态等。
- **备选事件流：**
    *   3.2.3.1.2.A. 无符合条件的申请记录
        1.  系统提示"未找到符合条件的申请记录"。
        2.  列表显示为空。

###### 3.2.3.1.3 用例名称：审核商户注册申请
- **参与者：** 系统管理员
- **前置条件：**
    - 管理员已登录系统。
    - 管理员具有审核商户注册申请的权限。
    - 已查询并展示商户注册申请列表。
- **后置条件：**
    - 选定商户的注册申请状态被更新（通过或拒绝）。
    - 若通过，可能触发创建商户账户和店铺的后续流程。
    - 系统记录操作日志。
- **主事件流：**
    1. 管理员在商户注册申请列表中选择一个待审核的申请。
    2. 管理员点击"审核"操作，进入审核详情页面（可查看申请信息及资质）。
    3. 管理员选择审核结果："通过"或"拒绝"。
    4. 若选择"拒绝"，管理员输入审核意见（拒绝原因）。
    5. 管理员提交审核结果。
    6. 系统更新数据库中该申请的状态和审核意见。
    7. 如果审核通过，系统根据业务逻辑处理后续操作（如创建商户账户、初始化店铺等）。
    8. 系统刷新申请列表或返回列表页。
    9. 系统向管理员反馈操作成功的信息。
- **备选事件流：**
    *   3.2.3.1.3.A. 审核信息不完整
        1.  如果选择"拒绝"但未填写审核意见，系统提示"请输入审核意见"。
        2.  管理员补充信息后重新提交。
    *   3.2.3.1.3.B. 审核操作失败
        1.  系统提示"审核操作失败，请稍后重试"。
        2.  申请状态未改变。

###### 3.2.3.1.4 用例名称：修改商户状态
- **参与者：** 系统管理员
- **前置条件：**
    - 管理员已登录系统。
    - 管理员具有修改商户状态的权限。
    - 已查询并展示商户列表。
- **后置条件：**
    - 选定商户的状态被成功修改（如：正常、禁用、责令整改）。
    - 系统记录操作日志。
- **主事件流：**
    1. 管理员在商户列表中选中一个需要修改状态的商户。
    2. 管理员选择修改状态的操作（如点击"修改状态"按钮）。
    3. 系统弹出状态修改对话框，管理员选择新的状态并可填写原因。
    4. 管理员确认修改商户状态。
    5. 系统更新数据库中对应商户的状态字段及原因。
    6. 系统刷新商户列表，显示更新后的商户状态。
    7. 系统向管理员反馈操作成功的信息。
- **备选事件流：**
    *   3.2.3.1.4.A. 修改失败
        1.  系统提示"修改商户状态失败，请稍后重试"。
        2.  商户状态未改变。

###### 3.2.3.1.5 用例名称：查看商户资质信息
- **参与者：** 系统管理员
- **前置条件：**
    - 管理员已登录系统。
    - 管理员具有查看商户资质的权限。
    - 正在查看商户详情或审核商户申请。
- **后置条件：**
    - 系统展示指定商户提交的资质证明材料。
- **主事件流：**
    1. 管理员在商户详情页或审核页面中，点击"查看资质"或类似链接。
    2. 系统根据商户ID查询该商户上传的资质信息（如营业执照、法人身份证等）。
    3. 系统在界面上展示资质图片的缩略图或列表，管理员可点击查看大图。
- **备选事件流：**
    *   3.2.3.1.5.A. 商户未上传资质或资质信息不存在
        1.  系统提示"该商户未上传资质信息"或"资质信息不存在"。

##### 3.2.3.2 商户分类管理

###### 3.2.3.2.1 用例名称：查询商户分类列表
- **参与者：** 系统管理员
- **前置条件：**
    - 管理员已登录系统。
    - 管理员具有管理商户分类的权限。
- **后置条件：**
    - 系统展示所有商户分类信息。
- **主事件流：**
    1. 管理员在导航菜单中选择"商户管理"下的"商户分类管理"功能。
    2. 系统从数据库中检索所有商户分类信息。
    3. 系统在界面上分页展示商户分类列表，包括分类ID、名称、图标、排序等。
- **备选事件流：**
    *   3.2.3.2.1.A. 无分类信息
        1.  系统提示"暂无商户分类信息"。
        2.  列表显示为空。

###### 3.2.3.2.2 用例名称：新增商户分类
- **参与者：** 系统管理员
- **前置条件：**
    - 管理员已登录系统。
    - 管理员具有新增商户分类的权限。
- **后置条件：**
    - 新的商户分类被成功添加到系统中。
    - 系统记录操作日志。
- **主事件流：**
    1. 管理员在商户分类管理页面点击"新增分类"按钮。
    2. 系统显示新增商户分类的表单，要求输入分类名称、上传图标、设置排序等。
    3. 管理员填写分类信息并提交。
    4. 系统验证输入信息的合法性（如名称是否已存在）。
    5. 系统将新的分类信息保存到数据库。
    6. 系统刷新商户分类列表，显示新增的分类。
    7. 系统向管理员反馈操作成功的信息。
- **备选事件流：**
    *   3.2.3.2.2.A. 输入信息不合法
        1.  系统提示错误信息（如"分类名称不能为空"、"分类名称已存在"）。
        2.  管理员修改信息后重新提交。
    *   3.2.3.2.2.B. 新增失败
        1.  系统提示"新增商户分类失败，请稍后重试"。

###### 3.2.3.2.3 用例名称：修改商户分类
- **参与者：** 系统管理员
- **前置条件：**
    - 管理员已登录系统。
    - 管理员具有修改商户分类的权限。
    - 已查询并展示商户分类列表。
- **后置条件：**
    - 选定商户分类的信息被成功更新。
    - 系统记录操作日志。
- **主事件流：**
    1. 管理员在商户分类列表中选择一个需要修改的分类，并点击"修改"或"编辑"按钮。
    2. 系统显示该分类的现有信息，并允许管理员修改分类名称、图标、排序等。
    3. 管理员修改分类信息并提交。
    4. 系统验证输入信息的合法性。
    5. 系统将更新后的分类信息保存到数据库。
    6. 系统刷新商户分类列表，显示更新后的分类。
    7. 系统向管理员反馈操作成功的信息。
- **备选事件流：**
    *   3.2.3.2.3.A. 输入信息不合法
        1.  系统提示错误信息。
        2.  管理员修改信息后重新提交。
    *   3.2.3.2.3.B. 修改失败
        1.  系统提示"修改商户分类失败，请稍后重试"。

###### 3.2.3.2.4 用例名称：删除商户分类
- **参与者：** 系统管理员
- **前置条件：**
    - 管理员已登录系统。
    - 管理员具有删除商户分类的权限。
    - 已查询并展示商户分类列表。
- **后置条件：**
    - 选定的商户分类被成功从系统中删除（逻辑删除或物理删除，取决于系统设计）。
    - 系统记录操作日志。
- **主事件流：**
    1. 管理员在商户分类列表中选择一个需要删除的分类，并点击"删除"按钮。
    2. 系统检查该分类下是否仍有关联商户。
    3. 系统提示管理员确认删除操作（若有关联商户，可能提示风险）。
    4. 管理员确认删除。
    5. 系统从数据库中删除该分类信息。
    6. 系统刷新商户分类列表。
    7. 系统向管理员反馈操作成功的信息。
- **备选事件流：**
    *   3.2.3.2.4.A. 分类下存在关联商户且不允许删除
        1.  系统提示"该分类下尚有关联商户，无法删除"或"请先处理关联商户"。
        2.  用例终止，分类未被删除。
    *   3.2.3.2.4.B. 删除失败
        1.  系统提示"删除商户分类失败，请稍后重试"。

#### 3.2.4 内容审核模块

##### 3.2.4.1 商品信息审核

###### 3.2.4.1.1 用例名称：查询待审核商品列表
- **参与者：** 系统管理员（内容审核员）
- **前置条件：**
    - 管理员已登录系统。
    - 管理员具有审核商品信息的权限。
- **后置条件：**
    - 系统展示待审核的商品列表。
- **主事件流：**
    1. 管理员在导航菜单中选择"内容审核"下的"商品审核"功能。
    2. 系统从数据库中检索所有状态为"待审核"的商品信息。
    3. 系统在界面上分页展示待审核商品列表，包括商品ID、名称、所属商铺、提交时间等。
- **备选事件流：**
    *   3.2.4.1.1.A. 无待审核商品
        1.  系统提示"暂无待审核的商品"。
        2.  列表显示为空。

###### 3.2.4.1.2 用例名称：审核商品信息
- **参与者：** 系统管理员（内容审核员）
- **前置条件：**
    - 管理员已登录系统。
    - 管理员具有审核商品信息的权限。
    - 已查询并展示待审核商品列表。
- **后置条件：**
    - 选定商品的审核状态被更新（通过或不通过）。
    - 若不通过，记录审核原因。
    - 系统记录操作日志。
- **主事件流：**
    1. 管理员在待审核商品列表中选择一个商品，点击"审核"操作。
    2. 系统展示该商品的详细信息供管理员审查。
    3. 管理员选择审核结果："审核通过"或"审核不通过"。
    4. 若选择"审核不通过"，管理员输入不通过的原因。
    5. 管理员提交审核结果。
    6. 系统更新数据库中该商品的审核状态和审核原因。
    7. 系统从未审核列表中移除该商品（如果审核通过或不通过后状态改变）。
    8. 系统向管理员反馈操作成功的信息，并可能通知商户审核结果。
- **备选事件流：**
    *   3.2.4.1.2.A. 审核信息不完整
        1.  如果选择"审核不通过"但未填写原因，系统提示"请输入审核不通过的原因"。
        2.  管理员补充信息后重新提交。
    *   3.2.4.1.2.B. 审核失败
        1.  系统提示"商品审核操作失败，请稍后重试"。

##### 3.2.4.2 用户评论审核

###### 3.2.4.2.1 用例名称：查询待审核评论列表
- **参与者：** 系统管理员（内容审核员）
- **前置条件：**
    - 管理员已登录系统。
    - 管理员具有审核用户评论的权限。
- **后置条件：**
    - 系统展示待审核的用户评论列表。
- **主事件流：**
    1. 管理员在导航菜单中选择"内容审核"下的"评论审核"功能。
    2. 系统从数据库中检索所有状态为"待审核"的用户评论。
    3. 管理员可以按评论类型（如店铺评价、博客评论）进行筛选。
    4. 系统在界面上分页展示待审核评论列表，包括评论ID、内容摘要、评论人、评论对象、提交时间等。
- **备选事件流：**
    *   3.2.4.2.1.A. 无待审核评论
        1.  系统提示"暂无待审核的评论"。
        2.  列表显示为空。

###### 3.2.4.2.2 用例名称：审核用户评论
- **参与者：** 系统管理员（内容审核员）
- **前置条件：**
    - 管理员已登录系统。
    - 管理员具有审核用户评论的权限。
    - 已查询并展示待审核评论列表。
- **后置条件：**
    - 选定评论的显示状态被更新（如：显示、隐藏/删除）。
    - 若隐藏/删除，可记录原因。
    - 系统记录操作日志。
- **主事件流：**
    1. 管理员在待审核评论列表中选择一个评论，点击"审核"操作。
    2. 系统展示该评论的详细内容。
    3. 管理员选择审核结果："显示评论"或"隐藏/删除评论"。
    4. 若选择"隐藏/删除评论"，管理员可输入操作原因。
    5. 管理员提交审核结果。
    6. 系统更新数据库中该评论的显示状态和审核原因。
    7. 系统从未审核列表中移除该评论。
    8. 系统向管理员反馈操作成功的信息。
- **备选事件流：**
    *   3.2.4.2.2.A. 审核信息不完整
        1.  如果选择"隐藏/删除评论"但未填写原因（若系统要求），系统提示补充。
        2.  管理员补充信息后重新提交。
    *   3.2.4.2.2.B. 审核失败
        1.  系统提示"评论审核操作失败，请稍后重试"。

##### 3.2.4.3 举报处理

###### 3.2.4.3.1 用例名称：查询举报列表
- **参与者：** 系统管理员（内容审核员/客服）
- **前置条件：**
    - 管理员已登录系统。
    - 管理员具有处理举报信息的权限。
- **后置条件：**
    - 系统根据筛选条件展示举报信息列表。
- **主事件流：**
    1. 管理员在导航菜单中选择"内容审核"下的"举报处理"功能。
    2. 系统默认显示待处理的举报列表。
    3. 管理员可以筛选处理状态（如：待处理、已处理）和举报内容类型。
    4. 系统在界面上分页展示举报列表，包括举报ID、举报人、被举报内容摘要、举报类型、举报理由、举报时间、处理状态等。
- **备选事件流：**
    *   3.2.4.3.1.A. 无举报信息
        1.  系统提示"暂无举报信息"。
        2.  列表显示为空。

###### 3.2.4.3.2 用例名称：处理举报信息
- **参与者：** 系统管理员（内容审核员/客服）
- **前置条件：**
    - 管理员已登录系统。
    - 管理员具有处理举报信息的权限。
    - 已查询并展示举报列表。
- **后置条件：**
    - 选定的举报信息被处理，状态更新。
    - 可能连带处理被举报内容或被举报用户。
    - 系统记录操作日志。
- **主事件流：**
    1. 管理员在举报列表中选择一个待处理的举报，点击"处理"操作。
    2. 系统展示举报详情，包括被举报内容的链接或快照。
    3. 管理员核实举报情况，并选择处理动作（如：删除内容、警告用户、封禁用户、忽略举报）。
    4. 管理员输入处理备注。
    5. 管理员提交处理结果。
    6. 系统根据管理员选择的动作执行相应操作（如更新被举报内容状态、更新用户状态等）。
    7. 系统更新举报信息的处理状态和备注。
    8. 系统向管理员反馈操作成功的信息。
- **备选事件流：**
    *   3.2.4.3.2.A. 处理信息不完整
        1.  系统提示必须填写处理备注或选择处理动作。
        2.  管理员补充信息后重新提交。
    *   3.2.4.3.2.B. 处理失败
        1.  系统提示"举报处理操作失败，请稍后重试"。

#### 3.2.5 系统监控与数据统计模块

##### 3.2.5.1 用例名称：查看核心数据统计
- **参与者：** 系统管理员
- **前置条件：**
    - 管理员已登录系统。
    - 管理员具有查看数据统计的权限。
- **后置条件：**
    - 系统展示核心业务数据的统计图表和摘要。
- **主事件流：**
    1. 管理员在导航菜单中选择"系统监控"或"数据统计"下的"核心数据摘要"功能。
    2. 管理员可以选择统计日期或时间范围（如：今日、昨日、近7天、近30天）。
    3. 系统从数据库或缓存中聚合分析数据，生成统计结果。
    4. 系统在界面上展示关键指标，如UV、DAU、新增用户数、订单量、交易总额等，可配合图表（折线图、柱状图）显示趋势。
- **备选事件流：**
    *   3.2.5.1.A. 数据暂无或生成失败
        1.  系统提示"统计数据正在生成中，请稍后"或"无法获取统计数据"。

##### 3.2.5.2 用例名称：数据导出
- **参与者：** 系统管理员
- **前置条件：**
    - 管理员已登录系统。
    - 管理员具有数据导出的权限。
- **后置条件：**
    - 管理员成功下载所需业务数据的报表文件。
    - 系统记录操作日志。
- **主事件流：**
    1. 管理员在导航菜单中选择"数据统计"下的"数据导出"功能。
    2. 系统显示数据导出配置界面。
    3. 管理员选择要导出的数据类型（如：用户列表、订单列表、商户列表等）。
    4. 管理员选择导出格式（如：CSV、Excel）。
    5. 管理员设置筛选条件（如：时间范围、状态等）。
    6. 管理员点击"导出"按钮。
    7. 系统根据配置查询数据，并生成相应格式的文件。
    8. （对于大量数据）系统可能提示任务已提交，稍后提供下载链接或异步生成后通知。
    9. （对于少量数据）系统直接触发文件下载。
- **备选事件流：**
    *   3.2.5.2.A. 导出配置错误
        1.  系统提示配置错误信息。
        2.  管理员修改配置后重新导出。
    *   3.2.5.2.B. 数据量过大导致同步导出超时
        1.  系统提示"数据量过大，建议使用异步导出或缩小范围"或自动转为异步任务。
    *   3.2.5.2.C. 导出失败
        1.  系统提示"数据导出失败，请稍后重试"。

##### 3.2.5.3 用例名称：查询预警历史
- **参与者：** 系统管理员
- **前置条件：**
    - 管理员已登录系统。
    - 管理员具有查看系统预警的权限。
- **后置条件：**
    - 系统展示已触发的预警历史记录。
- **主事件流：**
    1. 管理员在导航菜单中选择"系统监控"下的"预警历史"功能。
    2. 系统从数据库中检索已记录的预警信息。
    3. 管理员可以按预警级别、时间范围等条件进行筛选和排序。
    4. 系统在界面上分页展示预警历史列表，包括预警ID、预警名称、触发时间、详情、级别、状态（已触发、已解决）等。
- **备选事件流：**
    *   3.2.5.3.A. 无预警记录
        1.  系统提示"暂无预警历史记录"。
        2.  列表显示为空。

#### 3.2.6 管理员操作日志模块

##### 3.2.6.1 用例名称：查询管理员操作日志
- **参与者：** 超级管理员 (或具有审计权限的管理员)
- **前置条件：**
    - 管理员已登录系统。
    - 管理员具有查看操作日志的权限。
- **后置条件：**
    - 系统根据查询条件展示管理员的操作日志记录。
- **主事件流：**
    1. 管理员在导航菜单中选择"系统管理"或"安全审计"下的"操作日志"功能。
    2. 系统默认显示最近的操作日志。
    3. 管理员可以输入查询条件（如：操作管理员用户名、操作名称、请求URI、操作时间范围、IP地址、操作状态）。
    4. 管理员点击"搜索"或"查询"按钮。
    5. 系统根据管理员输入的条件从数据库中检索匹配的操作日志。
    6. 系统在界面上分页展示操作日志列表，包括日志ID、操作管理员、操作名称、请求URI、方法、参数、IP、耗时、状态、错误信息（若有）、操作时间等。
- **备选事件流：**
    *   3.2.6.1.A. 无符合条件的日志
        1.  系统提示"未找到符合条件的操作日志记录"。
        2.  列表显示为空。

## 4. 业务流程设计

阐述管理员模块核心功能的业务处理流程。

1.  **管理员登录认证流程:**
    *   管理员在登录页面输入用户名和密码。
    *   前端将凭证发送至 `POST /api/admin/login`。
    *   认证模块校验用户名密码：
        *   失败：返回错误码和提示信息。
        *   成功：生成 Sa-Token，包含管理员ID、角色等信息。
    *   返回Token及管理员基本信息给前端。
    *   前端后续请求携带Token访问其他接口。
    *   Sa-Token 框架自动进行Token校验和权限拦截。

2.  **用户状态修改流程:**
    *   管理员在用户列表选择用户，点击"禁用/启用"。
    *   前端调用 `PUT /api/admin/users/{userId}/status`，携带新的状态。
    *   用户管理服务层校验权限。
    *   更新 `hmdp_user` 表中对应用户的 `status` 字段。
    *   记录操作日志到 `hmdp_admin_audit_log`。
    *   返回操作成功响应。

3.  **商户注册申请审核流程:**
    *   管理员查看 `GET /api/admin/merchants/applications` 获取待审核列表。
    *   选择一个申请，查看详情（包括资质 `GET /api/admin/merchants/{merchantId}/qualifications`）。
    *   管理员做出审核决定（通过/拒绝）。
    *   前端调用 `PUT /api/admin/merchants/applications/{applicationId}/audit`，携带审核结果 (`status`) 和审核意见 (`auditComment`)。
    *   商户管理服务层校验权限。
    *   更新 `hmdp_merchant_application` 表的 `status` 和 `audit_comment`。
    *   如果审核通过：
        *   可能触发创建商户账户、店铺记录等后续逻辑（根据具体业务定）。
        *   通知申请人审核结果。
    *   如果审核拒绝：
        *   通知申请人审核结果及原因。
    *   记录操作日志。
    *   返回操作成功响应。

4.  **商品信息审核流程:**
    *   管理员查看 `GET /api/admin/content/products/pending` 获取待审核商品列表。
    *   选择一个商品，查看商品详情。
    *   管理员做出审核决定（通过/不通过）。
    *   前端调用 `PUT /api/admin/content/products/{productId}/audit`，携带审核结果 (`status`) 和原因 (`reason`)。
    *   内容审核服务层校验权限。
    *   更新 `hmdp_product` 表中对应商品的审核状态 (`audit_status`, `audit_reason`)。
    *   如果审核通过，商品变为可售状态。
    *   如果审核不通过，通知商户原因。
    *   记录操作日志。
    *   返回操作成功响应。

5.  **举报处理流程:**
    *   管理员查看 `GET /api/admin/content/reports` 获取待处理举报列表。
    *   选择一个举报，查看举报详情及被举报内容。
    *   管理员进行核实，并决定处理动作。
    *   前端调用 `PUT /api/admin/content/reports/{reportId}/process`，携带处理动作 (`action`) 和备注 (`remarks`)。
    *   内容审核服务层校验权限。
    *   根据 `action` 执行相应操作：
        *   `DELETE_CONTENT`: 删除被举报的内容（商品、评论等）。
        *   `WARN_USER`: 向被举报用户发送警告。
        *   `BAN_USER`: 禁用被举报用户账户若干天。
        *   `IGNORE_REPORT`: 忽略此举报。
    *   更新 `hmdp_report` 表的处理状态和结果。
    *   记录操作日志。
    *   返回操作成功响应。

6.  **数据导出流程:**
    *   管理员在数据导出页面选择数据类型、日期范围、筛选条件和导出格式。
    *   前端调用 `GET /api/admin/data-export`。
    *   数据统计服务层校验权限。
    *   根据参数查询数据库，获取数据。
    *   （对于大量数据）可采用异步生成文件的方式：
        *   立即返回任务ID，前端轮询任务状态。
        *   后端异步生成文件，完成后提供下载链接。
    *   （对于少量数据）可直接生成文件流返回给前端下载。
    *   记录操作日志。

## 5. 技术实现方案

针对各模块功能的具体技术实现要点。

*   **认证与授权 (Sa-Token):**
    *   自定义 `StpInterface` 实现，用于查询管理员的角色和权限列表。
    *   配置 Sa-Token 拦截规则，对 `/api/admin/**` 路径下的接口（除登录外）进行登录和权限校验。
    *   使用 `@SaCheckLogin`, `@SaCheckRole`, `@SaCheckPermission` 等注解进行细粒度权限控制。
    *   密码存储采用强哈希算法（如 BCrypt）。

*   **用户管理 / 商户管理 / 内容审核中的状态修改:**
    *   Service 层方法使用 `@Transactional` 注解保证事务一致性。
    *   Repository 层使用 MyBatis-Plus 提供的 `updateById` 或自定义 SQL 进行更新。
    *   关键操作前进行充分的参数校验和权限检查。

*   **商户分类管理 (ShopType):**
    *   标准的 CRUD 操作，注意在删除分类时，需要检查该分类下是否仍有关联商户，并根据业务规则决定是否允许删除或进行级联处理。

*   **列表查询与分页:**
    *   使用 MyBatis-Plus 提供的分页插件 `PaginationInterceptor` 简化分页实现。
    *   Controller 层接收 `page` 和 `size` 参数，传递给 Service 层。
    *   Service 层构建查询条件，调用 Repository 层进行分页查询。

*   **数据导出:**
    *   使用 EasyExcel (Java) 或类似库处理 CSV/Excel 文件的生成。
    *   提供模板功能，规范导出格式。
    *   对于大数据量导出，考虑流式写入，避免内存溢出，并结合异步任务。

*   **核心数据统计:**
    *   对于UV、DAU等指标，可以结合 Redis HyperLogLog 或定时任务从访问日志、订单数据中聚合分析。
    *   Service 层提供接口封装统计逻辑，可缓存常用统计结果以提升响应速度。

*   **预警管理:**
    *   查询 `hmdp_alert_history` 表，根据前端传入的筛选条件进行过滤和分页。

*   **操作日志记录:**
    *   通过 Spring AOP + 自定义注解实现。
    *   切面捕获 Controller 层方法的调用，记录请求信息、操作人、IP、耗时等。
    *   异步保存日志到 `hmdp_admin_audit_log` 表，避免影响主业务流程性能。

*   **统一异常处理:**
    *   使用 `@RestControllerAdvice` 和 `@ExceptionHandler` 定义全局异常处理器。
    *   捕获业务异常、权限异常、参数校验异常等，返回统一的错误响应格式。

## 6. 技术选型建议

*   **后端框架:** Spring Boot (Java) - 成熟稳定，生态丰富，快速开发。
*   **数据访问层:** MyBatis-Plus - 增强 MyBatis，简化 CRUD，提供分页、逻辑删除等便捷功能。
*   **认证与授权:** Sa-Token - 轻量级、功能强大的权限认证框架，与 Spring Boot 集成良好。
*   **数据库:** MySQL 8.x 或 PostgreSQL - 开源关系型数据库，性能优异。
*   **缓存:** Redis - 高性能键值存储，用于缓存热点数据、Session管理、分布式锁等。
*   **日志框架:** SLF4J + Logback/Log4j2 - 灵活强大的日志解决方案。
*   **API 文档生成:** SpringDoc OpenAPI (替代 Swagger) - 与 Spring Boot 完美集成，自动生成 OpenAPI 3.0 规范的文档。
*   **数据导出库:** EasyExcel (阿里巴巴) - 简单易用，性能优越的Java Excel处理库。
*   **JSON处理:** Jackson (Spring Boot 默认集成) 或 Fastjson2。
*   **构建工具:** Maven
*   