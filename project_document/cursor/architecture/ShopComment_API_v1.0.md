# 商店评论系统 API 设计 v1.0

**创建时间:** [2024-07-29 12:35:00 +08:00]  
**创建者:** AR (架构师)  
**文档状态:** 已批准  

## 更新日志

| 版本 | 日期 | 更新者 | 更新内容 | 更新原因 |
|------|------|--------|----------|----------|
| 1.0 | [2024-07-29 12:35:00 +08:00] | AR | 初始版本 | 创建商店评论系统API设计文档 |

## API 端点

### 1. 评论管理 API

#### 1.1 创建评论

- **URL:** `/api/shop-comment`
- **方法:** `POST`
- **权限:** 已登录用户
- **描述:** 用户为商店创建评论，必须关联到有效订单

**请求体:**
```json
{
  "shopId": 1,       // 商店ID
  "orderId": 100,    // 订单ID
  "rating": 5,       // 评分(1-5)
  "content": "这家店很好，服务很周到！" // 评论内容
}
```

**响应:**
```json
{
  "success": true,
  "data": {
    "id": 1,
    "shopId": 1,
    "userId": 10,    // 从当前登录用户获取
    "orderId": 100,
    "rating": 5,
    "content": "这家店很好，服务很周到！",
    "createTime": "2024-07-29T12:30:00",
    "userNickname": "用户昵称",
    "userIcon": "用户头像URL"
  },
  "errorMsg": null
}
```

**错误情况:**
- 400: 参数无效（评分不在1-5范围内，内容为空等）
- 403: 无权限（用户未登录）
- 404: 商店或订单不存在
- 409: 该订单已经评论过或订单不属于该用户/商店

#### 1.2 获取商店评论列表

- **URL:** `/api/shop-comment/shop/{shopId}`
- **方法:** `GET`
- **权限:** 公开
- **描述:** 获取指定商店的评论列表，支持分页和排序

**请求参数:**
- `current`: 当前页码，默认1
- `sortBy`: 排序字段，可选值：time（时间）、rating（评分）、hotness（热度），默认time
- `order`: 排序方向，可选值：desc（降序）、asc（升序），默认desc

**响应:**
```json
{
  "success": true,
  "data": {
    "records": [
      {
        "id": 1,
        "shopId": 1,
        "userId": 10,
        "rating": 5,
        "content": "这家店很好，服务很周到！",
        "createTime": "2024-07-29T12:30:00",
        "userNickname": "用户昵称",
        "userIcon": "用户头像URL",
        "isCurrentUserComment": false  // 是否是当前登录用户的评论
      },
      // ...更多评论
    ],
    "total": 100,      // 总评论数
    "pages": 20,       // 总页数
    "current": 1,      // 当前页
    "size": 5          // 每页大小
  },
  "errorMsg": null
}
```

**错误情况:**
- 400: 参数无效
- 404: 商店不存在

#### 1.3 用户删除自己的评论

- **URL:** `/api/shop-comment/{commentId}`
- **方法:** `DELETE`
- **权限:** 已登录用户（评论所有者）
- **描述:** 用户删除自己的评论（软删除）

**响应:**
```json
{
  "success": true,
  "data": null,
  "errorMsg": null
}
```

**错误情况:**
- 403: 无权限（非评论所有者）
- 404: 评论不存在

#### 1.4 管理员删除评论

- **URL:** `/api/shop-comment/admin/{commentId}`
- **方法:** `DELETE`
- **权限:** 管理员
- **描述:** 管理员删除评论（软删除）

**响应:**
```json
{
  "success": true,
  "data": null,
  "errorMsg": null
}
```

**错误情况:**
- 403: 无权限（非管理员）
- 404: 评论不存在

### 2. 评论举报 API

#### 2.1 举报评论

- **URL:** `/api/comment-report`
- **方法:** `POST`
- **权限:** 已登录商家
- **描述:** 商家举报不当评论

**请求体:**
```json
{
  "commentId": 1,
  "reason": "包含不实信息"
}
```

**响应:**
```json
{
  "success": true,
  "data": {
    "id": 1,
    "commentId": 1,
    "reporterId": 20,  // 从当前登录用户获取
    "reason": "包含不实信息",
    "status": 0,       // 0=待处理
    "createTime": "2024-07-29T12:40:00"
  },
  "errorMsg": null
}
```

**错误情况:**
- 400: 参数无效
- 403: 无权限（非商家）
- 404: 评论不存在
- 409: 该评论已被举报过

#### 2.2 获取待处理举报列表

- **URL:** `/api/comment-report/admin/pending`
- **方法:** `GET`
- **权限:** 管理员
- **描述:** 获取待处理的举报列表

**请求参数:**
- `current`: 当前页码，默认1

**响应:**
```json
{
  "success": true,
  "data": {
    "records": [
      {
        "id": 1,
        "commentId": 1,
        "reporterId": 20,
        "reporterName": "商家名称",
        "reason": "包含不实信息",
        "status": 0,
        "createTime": "2024-07-29T12:40:00",
        "comment": {
          "id": 1,
          "content": "评论内容",
          "rating": 5,
          "shopId": 1,
          "shopName": "商店名称",
          "userId": 10,
          "userNickname": "用户昵称"
        }
      },
      // ...更多举报
    ],
    "total": 50,       // 总举报数
    "pages": 10,       // 总页数
    "current": 1,      // 当前页
    "size": 5          // 每页大小
  },
  "errorMsg": null
}
```

**错误情况:**
- 403: 无权限（非管理员）

#### 2.3 处理举报

- **URL:** `/api/comment-report/admin/{reportId}`
- **方法:** `PUT`
- **权限:** 管理员
- **描述:** 处理举报（批准或拒绝）

**请求参数:**
- `approveReport`: 是否批准举报（true=批准并隐藏评论，false=拒绝举报）

**响应:**
```json
{
  "success": true,
  "data": null,
  "errorMsg": null
}
```

**错误情况:**
- 403: 无权限（非管理员）
- 404: 举报不存在

## 热度计算算法

对于MVP版本，评论热度计算采用简化的算法：

```
热度得分 = (评分 * 0.6) + (时间衰减因子 * 0.4)
```

其中:
- 评分部分：原始评分（1-5分）/ 5 * 100
- 时间衰减因子：100 * exp(-0.05 * 天数)，其中"天数"是评论发布至今的天数

这样，新发布的高评分评论会获得较高的热度，随着时间推移热度逐渐降低。

## 权限控制

- 创建评论：需要用户登录，且有对应的已完成订单
- 查看评论：公开访问
- 删除评论：用户只能删除自己的评论，管理员可以删除任何评论
- 举报评论：需要商家身份
- 处理举报：需要管理员身份

## 注意事项

1. 所有评论查询默认只返回状态为正常(status=0)的评论
2. 评论删除采用软删除策略，通过status字段标记
3. 评论必须关联到有效订单，确保只有实际购买过的用户才能评论
4. 每个订单只能提交一次评论
5. 热度算法在MVP阶段采用简化版本，后续可根据实际需求调整